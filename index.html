<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SEH-kader-BUR: GeliÅŸmiÅŸ Versiyon</title>
    <style>
        body {
            margin: 0;
            background: #050505;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
        }
        #gameContainer {
            position: relative;
            box-shadow: 0 0 60px rgba(0, 255, 255, 0.1);
        }
        canvas {
            background: #0a0a10;
            display: block;
            border: 2px solid #333;
        }
        
        /* UI ArayÃ¼z */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box;
        }
        .top-bar { 
            display: flex; 
            justify-content: space-between; 
            width: 100%; 
            align-items: flex-start;
            text-shadow: 2px 2px 4px black; 
        }
        
        .player-stats {
            display: flex; flex-direction: column; gap: 5px;
        }
        .hp-bar-container { width: 200px; background: #333; height: 15px; border: 2px solid white; position: relative; }
        .hp-fill { height: 100%; transition: width 0.2s; }
        #hp-blue { background: cyan; width: 100%; box-shadow: 0 0 10px cyan; }
        #hp-red { background: #ff4444; width: 100%; box-shadow: 0 0 10px #ff4444; }
        
        .score-text { font-size: 18px; font-weight: bold; margin-top: 5px; letter-spacing: 1px; }

        /* Orta Puan GÃ¶stergesi */
        #total-score-display {
            position: absolute; top: 10px; width: 100%; text-align: center;
            font-size: 32px; font-weight: 800; color: white;
            text-shadow: 0 0 15px rgba(255,255,255,0.5);
            pointer-events: none;
        }

        #mission-display {
            position: absolute; top: 60px; width: 100%;
            text-align: center; font-size: 20px; font-weight: bold;
            color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            background: rgba(0,0,0,0.3); padding: 5px 0;
        }

        /* BaÅŸlangÄ±Ã§ EkranÄ± */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 200; cursor: pointer;
            backdrop-filter: blur(5px);
        }
        #start-screen h1 { font-size: 60px; color: cyan; margin: 0; text-shadow: 0 0 30px cyan; }
        #start-screen p { font-size: 24px; color: white; animation: blink 1s infinite; margin-top: 20px; }

        /* Upgrade Modal */
        #upgrade-modal {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 10, 15, 0.98); border: 2px solid #ffd700;
            padding: 30px; text-align: center; pointer-events: auto;
            border-radius: 15px; z-index: 100; min-width: 500px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
        }
        #upgrade-modal h2 { color: #ffd700; margin-top: 0; text-shadow: 0 0 10px gold; }
        
        .upgrade-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px;
        }
        .upgrade-card {
            background: #222; border: 1px solid #444; padding: 15px;
            cursor: pointer; transition: 0.2s; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 120px;
        }
        .upgrade-card:hover { background: #333; border-color: cyan; transform: scale(1.05); box-shadow: 0 0 15px rgba(0,255,255,0.3); }
        .upgrade-icon { font-size: 30px; margin-bottom: 10px; }
        .upgrade-title { font-size: 14px; font-weight: bold; color: white; }
        .upgrade-desc { font-size: 11px; color: #aaa; margin-top: 5px; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="1000" height="700"></canvas>
    
    <div id="start-screen" onclick="startGame()">
        <h1>SEH-kader-BUR</h1>
        <p>BAÅžLAMAK Ä°Ã‡Ä°N TIKLA</p>
        <div style="margin-top:30px; font-size:16px; color:#aaa; text-align: center; line-height: 1.6;">
            <strong style="color:cyan">MAVÄ°:</strong> W,A,S,D + SHIFT (Dash)<br>
            <strong style="color:#ff4444">KIRMIZI:</strong> YÃ¶n TuÅŸlarÄ± + ENTER (Dash)<br>
            <span style="font-size:14px; color: gold;">AmaÃ§: Ä°p kopmadan hayatta kal ve gÃ¶revleri tamamla!</span>
        </div>
    </div>

    <div id="ui-layer">
        <div id="total-score-display">0</div>
        
        <div class="top-bar">
            <div class="player-stats">
                <div style="color:cyan; font-weight:bold;">MAVÄ° OYUNCU</div>
                <div class="hp-bar-container"><div id="hp-blue" class="hp-fill"></div></div>
                <div class="score-text" style="color:cyan">Puan: <span id="score-p1">0</span></div>
            </div>
            
            <div class="player-stats" style="align-items: flex-end;">
                <div style="text-align:right; color:#ff4444; font-weight:bold;">KIRMIZI OYUNCU</div>
                <div class="hp-bar-container"><div id="hp-red" class="hp-fill"></div></div>
                <div class="score-text" style="color:#ff4444">Puan: <span id="score-p2">0</span></div>
            </div>
        </div>
    </div>

    <div id="mission-display">
        <div id="mission-text">ISINMA TURU</div>
        <div id="mission-timer" style="font-size:16px; color:white;">15s</div>
    </div>

    <div id="upgrade-modal">
        <h2>GÃ–REV TAMAMLANDI!</h2>
        <p style="color:#ddd; margin-bottom:10px;">Bir Ã¶dÃ¼l seÃ§:</p>
        <div id="upgrade-options" class="upgrade-grid"></div>
    </div>
</div>

<script>
// --- Audio System ---
const CUSTOM_HEART_SOUND_URL = 'https://raw.githubusercontent.com/l4Vuk/sites/main/sehburyeah.mp3'; 
const heartAudio = new Audio(CUSTOM_HEART_SOUND_URL);
heartAudio.volume = 0.5;

const AudioSys = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    playTone(freq, type, duration, vol=0.1) {
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    playShoot() { this.playTone(400 + Math.random()*200, 'square', 0.1, 0.05); },
    playHit() { this.playTone(100, 'sawtooth', 0.2, 0.1); },
    playShield() { this.playTone(800, 'sine', 0.1, 0.1); },
    playWin() { this.playTone(600, 'triangle', 0.1, 0.1); setTimeout(()=>this.playTone(800,'triangle',0.2,0.1), 100); },
    playLoveSound() {
        heartAudio.currentTime = 0;
        heartAudio.play().catch(e => console.log(e));
    }
};

// --- OYUN DEÄžÄ°ÅžKENLERÄ° ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const GAME = {
    width: 1000, height: 700,
    state: 'MENU',
    difficulty: 1, 
    time: 0,
    gameSpeed: 1.0,
    maxTetherDist: 400, // BaÅŸlangÄ±Ã§ ip uzunluÄŸu
    goldMultiplier: 1,  // AltÄ±n Ã§arpanÄ±
    totalScore: 0,
    mission: { active: false, type: null, target: 0, current: 0, endTime: 0, failedDamage: false }
};

const keys = {};
window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

// --- ARKA PLAN GRID SÄ°STEMÄ° ---
class BackgroundGrid {
    constructor(width, height, cellSize) {
        this.cellSize = cellSize;
        this.cols = Math.ceil(width / cellSize);
        this.rows = Math.ceil(height / cellSize);
        this.cells = [];
        for(let i=0; i<this.cols * this.rows; i++) {
            this.cells.push({ val: 0 });
        }
    }

    update(p1, p2) {
        for(let i=0; i<this.cells.length; i++) {
            this.cells[i].val *= 0.92;
            if(this.cells[i].val < 0.01) this.cells[i].val = 0;
        }
        [p1, p2].forEach(p => {
            let cx = Math.floor(p.x / this.cellSize);
            let cy = Math.floor(p.y / this.cellSize);
            if(cx >= 0 && cx < this.cols && cy >= 0 && cy < this.rows) {
                let index = cy * this.cols + cx;
                this.cells[index].val = 1.5;
                let neighbors = [index-1, index+1, index-this.cols, index+this.cols];
                neighbors.forEach(n => { if(this.cells[n]) this.cells[n].val = Math.max(this.cells[n].val, 0.5); });
            }
        });
    }

    draw(ctx) {
        ctx.lineWidth = 1;
        for(let y=0; y<this.rows; y++) {
            for(let x=0; x<this.cols; x++) {
                let index = y * this.cols + x;
                let cell = this.cells[index];
                let posX = x * this.cellSize;
                let posY = y * this.cellSize;

                if(cell.val > 0.05) {
                    let center = this.cellSize / 2;
                    let scale = 1 - (cell.val * 0.65);
                    ctx.save();
                    ctx.translate(posX + center, posY + center);
                    ctx.scale(scale, scale);
                    ctx.strokeStyle = `rgba(100, 200, 255, ${cell.val * 0.6})`;
                    ctx.fillStyle = `rgba(100, 200, 255, ${cell.val * 0.1})`;
                    ctx.beginPath();
                    ctx.rect(-center, -center, this.cellSize, this.cellSize);
                    ctx.fill(); ctx.stroke();
                    ctx.restore();
                } else {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
                    ctx.strokeRect(posX, posY, this.cellSize, this.cellSize);
                }
            }
        }
    }
}

// --- OYUNCU SINIFI ---
class Player {
    constructor(x, y, color, role) {
        this.x = x; this.y = y;
        this.color = color; this.role = role;
        this.hp = 100; 
        this.maxHp = 100;
        this.baseSpeed = 300;
        this.speedMult = 1.0;
        this.dashCooldown = 0;
        this.score = 0;
        this.pickupRange = 25; // BaÅŸlangÄ±Ã§ toplama alanÄ±
    }

    update(dt, partner) {
        if (this.dashCooldown > 0) this.dashCooldown -= dt;

        let dx = 0, dy = 0;
        if (this.role === 'blue') {
            if (keys['KeyW']) dy = -1;
            if (keys['KeyS']) dy = 1;
            if (keys['KeyA']) dx = -1;
            if (keys['KeyD']) dx = 1;
            if (keys['ShiftLeft'] && this.dashCooldown <= 0 && (dx||dy)) this.performDash(dx, dy, partner);
        } else {
            if (keys['ArrowUp']) dy = -1;
            if (keys['ArrowDown']) dy = 1;
            if (keys['ArrowLeft']) dx = -1;
            if (keys['ArrowRight']) dx = 1;
            if (keys['Enter'] && this.dashCooldown <= 0 && (dx||dy)) this.performDash(dx, dy, partner);
        }

        if (dx !== 0 || dy !== 0) {
            const len = Math.sqrt(dx*dx + dy*dy);
            dx /= len; dy /= len;
        }

        const dist = Math.hypot(this.x - partner.x, this.y - partner.y);
        let tension = dist / GAME.maxTetherDist;
        if (tension > 1) tension = 1;

        let physicsSpeedMod = 1.0 - (tension * 0.9); 
        if (physicsSpeedMod < 0.2) physicsSpeedMod = 0.2;

        const finalSpeed = this.baseSpeed * this.speedMult * physicsSpeedMod;

        this.x += dx * finalSpeed * dt * GAME.gameSpeed;
        this.y += dy * finalSpeed * dt * GAME.gameSpeed;

        this.x = Math.max(15, Math.min(GAME.width-15, this.x));
        this.y = Math.max(15, Math.min(GAME.height-15, this.y));
    }

    performDash(dx, dy, partner) {
        this.dashCooldown = 5.0; // Dash sÃ¼resi kÄ±saldÄ±
        this.x += dx * 120;
        this.y += dy * 120;
        
        setTimeout(() => {
            if (GAME.state === 'GAMEOVER') return;
            partner.x = this.x;
            partner.y = this.y;
            particles.push(new Particle(this.x, this.y, 'white', 'Ã‡EKÄ°LDÄ°!', 20));
            AudioSys.playTone(600, 'square', 0.1);
        }, 150);
    }

    draw(ctx) {
        // Manyetik alan gÃ¶stergesi (Ä°steÄŸe baÄŸlÄ±)
        /*
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.pickupRange, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(255,255,255,0.1)`;
        ctx.stroke();
        */

        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, 15, 0, Math.PI*2); ctx.fill();
        
        // Dash cooldown gÃ¶stergesi
        if (this.dashCooldown > 0) {
            ctx.strokeStyle = 'rgba(255,255,255,0.5)'; ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 22, 0, (this.dashCooldown/5.0) * Math.PI*2);
            ctx.stroke();
        }
    }
}

// --- NESNELER ---
class Bullet {
    constructor(x, y, target, isRed) {
        this.x = x; this.y = y; this.isRed = isRed;
        this.color = isRed ? '#ff4444' : 'cyan';
        const angle = Math.atan2(target.y - y, target.x - x);
        const speed = 150 + (GAME.difficulty * 15);
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.life = 10;
    }
    update(dt) {
        this.x += this.vx * dt * GAME.gameSpeed;
        this.y += this.vy * dt * GAME.gameSpeed;
        this.life -= dt;
    }
    draw(ctx) {
        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, 6, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 10; ctx.shadowColor = this.color; 
        ctx.fill(); ctx.shadowBlur = 0;
    }
}

class Item {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = type;
        this.timer = 12; // EÅŸyalar daha hÄ±zlÄ± kaybolsun
        this.scale = 1;
    }
    draw(ctx) {
        // KÃ¼Ã§Ã¼k animasyon
        this.scale = 1 + Math.sin(Date.now() * 0.01) * 0.2;
        ctx.font = `${20 * this.scale}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        if (this.type === 'gold') { ctx.fillStyle = "gold"; ctx.fillText("ðŸ’°", this.x, this.y); }
        else {
            let c = (this.type === 'heart_blue') ? 'cyan' : (this.type === 'heart_red') ? 'red' : '#0f0';
            ctx.fillStyle = c; ctx.fillText("â™¥", this.x, this.y);
        }
    }
}

class Particle {
    constructor(x, y, color, text, size=14) {
        this.x = x; this.y = y; this.color = color; this.text = text;
        this.life = 1.0; this.size = size;
    }
    update(dt) { this.y -= 40 * dt; this.life -= 1.5 * dt; }
    draw(ctx) {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color; ctx.font = `bold ${this.size}px Arial`;
        ctx.fillText(this.text, this.x, this.y); ctx.globalAlpha = 1.0;
    }
}

// --- INIT & LOOP ---
const P1 = new Player(400, 350, 'cyan', 'blue');
const P2 = new Player(600, 350, '#ff4444', 'red');
const bgGrid = new BackgroundGrid(GAME.width, GAME.height, 10); 
let bullets = [], items = [], particles = [];
let lastTime = 0, loveModeTimer = 0;

function startGame() {
    document.getElementById('start-screen').style.display = 'none';
    AudioSys.playTone(0, 'sine', 0); 
    GAME.state = 'WARMUP';
    requestAnimationFrame(gameLoop);
}

function spawnEnemy() {
    const side = Math.floor(Math.random() * 4);
    let x, y;
    if (side===0) {x=Math.random()*GAME.width; y=-20;}
    if (side===1) {x=Math.random()*GAME.width; y=GAME.height+20;}
    if (side===2) {x=-20; y=Math.random()*GAME.height;}
    if (side===3) {x=GAME.width+20; y=Math.random()*GAME.height;}
    const isRed = Math.random() > 0.5;
    bullets.push(new Bullet(x, y, isRed ? P2 : P1, isRed));
}

function updateGame(dt) {
    if (GAME.state === 'UPGRADE') return;
    
    GAME.time += dt;
    if (loveModeTimer > 0) {
        loveModeTimer -= dt;
        if (loveModeTimer <= 0) GAME.gameSpeed = 1.0;
    }

    bgGrid.update(P1, P2);

    // Zorluk ve Spawn
    if (Math.random() < (0.015 + (GAME.difficulty * 0.005)) * GAME.gameSpeed) spawnEnemy();
    if (Math.random() < 0.01) items.push(new Item(Math.random()*GAME.width, Math.random()*GAME.height, 'gold'));
    if (Math.random() < 0.002) {
        const r = Math.random();
        let t = 'heart_green';
        if (r < 0.33) t = 'heart_blue'; else if (r < 0.66) t = 'heart_red';
        items.push(new Item(Math.random()*GAME.width, Math.random()*GAME.height, t));
    }

    P1.update(dt, P2); P2.update(dt, P1);
    
    // Kopma KontrolÃ¼
    const dist = Math.hypot(P1.x - P2.x, P1.y - P2.y);
    if (dist > GAME.maxTetherDist + 10) {
        const mx = (P1.x+P2.x)/2, my = (P1.y+P2.y)/2;
        P1.x = mx-10; P1.y = my; P2.x = mx+10; P2.y = my;
        P1.hp -= 5; P2.hp -= 5; // Ä°p koparsa can gider
        particles.push(new Particle(mx, my, 'white', 'Ä°P GERÄ°LDÄ°! -5 CAN', 18));
        AudioSys.playHit();
    }

    bullets.forEach(b => b.update(dt));
    items.forEach(i => i.timer -= dt);
    particles.forEach(p => p.update(dt));
    
    bullets = bullets.filter(b => b.life > 0 && b.x > -50 && b.x < GAME.width+50);
    items = items.filter(i => i.timer > 0);
    particles = particles.filter(p => p.life > 0);

    checkCollisions();
    updateMission(dt);
    updateUI();
}

function checkCollisions() {
    bullets = bullets.filter(b => {
        const d1 = Math.hypot(b.x-P1.x, b.y-P1.y);
        const d2 = Math.hypot(b.x-P2.x, b.y-P2.y);
        
        if (d1 < 21) {
            if (b.isRed) { 
                particles.push(new Particle(P1.x, P1.y, 'cyan', 'BLOK!'));
                AudioSys.playShield();
                if(GAME.mission.active && GAME.mission.type === 'KILL_RED') GAME.mission.current++;
                return false;
            } else {
                P1.hp -= 10;
                particles.push(new Particle(P1.x, P1.y, 'red', '-10 CAN'));
                AudioSys.playHit();
                GAME.mission.failedDamage = true;
                return false;
            }
        }
        if (d2 < 21) {
            if (!b.isRed) {
                particles.push(new Particle(P2.x, P2.y, '#ff4444', 'BLOK!'));
                AudioSys.playShield();
                if(GAME.mission.active && GAME.mission.type === 'KILL_BLUE') GAME.mission.current++;
                return false;
            } else {
                P2.hp -= 10;
                particles.push(new Particle(P2.x, P2.y, 'red', '-10 CAN'));
                AudioSys.playHit();
                GAME.mission.failedDamage = true;
                return false;
            }
        }
        return true;
    });

    items = items.filter(i => {
        const d1 = Math.hypot(i.x-P1.x, i.y-P1.y);
        const d2 = Math.hypot(i.x-P2.x, i.y-P2.y);
        let picker = null;
        
        // Dinamik Pickup Range kullanÄ±mÄ±
        if (d1 < P1.pickupRange) picker = P1; 
        else if (d2 < P2.pickupRange) picker = P2;

        if (picker) {
            if (i.type === 'gold') {
                GAME.mission.current++;
                let gain = 10 * GAME.goldMultiplier;
                picker.score += gain;
                GAME.totalScore += gain;
                particles.push(new Particle(i.x, i.y, 'gold', `+${gain} PUAN`));
                AudioSys.playShoot();
                return false;
            } else {
                let valid = (i.type==='heart_green') || (i.type==='heart_blue' && picker===P1) || (i.type==='heart_red' && picker===P2);
                if (valid) {
                    picker.hp = Math.min(picker.maxHp, picker.hp+25);
                    activateLoveMode();
                    return false;
                }
            }
        }
        return true;
    });
}

function updateUI() {
    document.getElementById('hp-blue').style.width = (P1.hp / P1.maxHp * 100) + "%";
    document.getElementById('hp-red').style.width = (P2.hp / P2.maxHp * 100) + "%";
    document.getElementById('score-p1').innerText = P1.score;
    document.getElementById('score-p2').innerText = P2.score;
    document.getElementById('total-score-display').innerText = GAME.totalScore;
}

function activateLoveMode() {
    loveModeTimer = 2.0;
    GAME.gameSpeed = 0.3;
    bullets = [];
    particles.push(new Particle(500, 350, 'pink', 'â™¥ SEHBURYEAH! â™¥', 30));
    AudioSys.playLoveSound();
}

function updateMission(dt) {
    const elText = document.getElementById('mission-text');
    const elTimer = document.getElementById('mission-timer');
    
    if (GAME.state === 'WARMUP') {
        if (GAME.time > 10) { GAME.state = 'PLAYING'; startNewMission(); }
        else { elText.innerText = "HAZIRLANIN!"; elTimer.innerText = Math.ceil(10-GAME.time)+"s"; }
        return;
    }

    if (!GAME.mission.active) return;
    const timeLeft = GAME.mission.endTime - GAME.time;
    elTimer.innerText = Math.ceil(timeLeft) + "s";
    
    // GÃ¶rev Metinleri
    if (GAME.mission.type === 'KILL_RED') elText.innerText = `GÃ–REV: ${Math.max(0, GAME.mission.target - GAME.mission.current)} KÄ±rmÄ±zÄ± Mermi Yok Et`;
    if (GAME.mission.type === 'KILL_BLUE') elText.innerText = `GÃ–REV: ${Math.max(0, GAME.mission.target - GAME.mission.current)} Mavi Mermi Yok Et`;
    if (GAME.mission.type === 'GOLD') elText.innerText = `GÃ–REV: ${Math.max(0, GAME.mission.target - GAME.mission.current)} AltÄ±n Topla`;
    if (GAME.mission.type === 'SURVIVE') elText.innerText = `GÃ–REV: HASAR ALMA!`;

    let success = false, fail = false;
    if (timeLeft <= 0) {
        if (GAME.mission.type === 'SURVIVE' && !GAME.mission.failedDamage) success = true;
        else fail = true;
    }
    if (GAME.mission.type !== 'SURVIVE' && GAME.mission.current >= GAME.mission.target) success = true;
    if (GAME.mission.type === 'SURVIVE' && GAME.mission.failedDamage) fail = true;

    if (fail) {
        P1.hp = Math.floor(P1.hp * 0.7); P2.hp = Math.floor(P2.hp * 0.7);
        particles.push(new Particle(500, 350, 'red', 'GÃ–REV BAÅžARISIZ!', 40));
        startNewMission();
    } else if (success) {
        GAME.state = 'UPGRADE';
        AudioSys.playWin();
        showUpgradeMenu();
    }
}

function startNewMission() {
    GAME.mission.active = true;
    GAME.mission.failedDamage = false;
    GAME.mission.current = 0;
    const types = ['KILL_RED', 'KILL_BLUE', 'GOLD', 'SURVIVE'];
    GAME.mission.type = types[Math.floor(Math.random()*types.length)];
    
    let baseTarget = 3 + Math.floor(GAME.difficulty/2);
    if (GAME.mission.type.includes('KILL')) GAME.mission.target = baseTarget;
    if (GAME.mission.type === 'GOLD') GAME.mission.target = baseTarget + 2;
    
    GAME.mission.endTime = GAME.time + 20 + (GAME.difficulty * 2);
}

// --- UPGRADE SÄ°STEMÄ° (YENÄ°LENMÄ°Åž) ---
function showUpgradeMenu() {
    const modal = document.getElementById('upgrade-modal');
    const container = document.getElementById('upgrade-options');
    container.innerHTML = '';
    modal.style.display = 'block';

    // TÃ¼m olasÄ± geliÅŸtirmeler
    const upgradePool = [
        {
            icon: "âš¡", title: "Mavi Motoru", desc: "Mavi HÄ±zÄ± +%15 artar",
            func: () => { P1.speedMult += 0.15; }
        },
        {
            icon: "ðŸ”¥", title: "KÄ±zÄ±l Ä°tki", desc: "KÄ±rmÄ±zÄ± HÄ±zÄ± +%15 artar",
            func: () => { P2.speedMult += 0.15; }
        },
        {
            icon: "ðŸ›¡ï¸", title: "Mavi ZÄ±rh", desc: "Mavi Max Can +30",
            func: () => { P1.maxHp += 30; P1.hp += 30; }
        },
        {
            icon: "ðŸ©¸", title: "KÄ±zÄ±l ZÄ±rh", desc: "KÄ±rmÄ±zÄ± Max Can +30",
            func: () => { P2.maxHp += 30; P2.hp += 30; }
        },
        {
            icon: "ðŸ§²", title: "MÄ±knatÄ±s", desc: "Ã–dÃ¼l Toplama AlanÄ± GeniÅŸler",
            func: () => { P1.pickupRange += 15; P2.pickupRange += 15; }
        },
        {
            icon: "ðŸ§µ", title: "Halat UzmanlÄ±ÄŸÄ±", desc: "Ä°p kopma mesafesi +60px",
            func: () => { GAME.maxTetherDist += 20; }
        },
        {
            icon: "ðŸ’Ž", title: "Servet", desc: "AltÄ±n Puan DeÄŸeri Artar (x2)",
            func: () => { GAME.goldMultiplier++; }
        },
        {
            icon: "ðŸ’Š", title: "Tam Ä°yileÅŸme", desc: "Ä°ki oyuncu da fullenir",
            func: () => { P1.hp = P1.maxHp; P2.hp = P2.maxHp; }
        }
    ];

    // Rastgele 3 tane seÃ§
    let choices = [];
    while(choices.length < 3) {
        let r = upgradePool[Math.floor(Math.random() * upgradePool.length)];
        if(!choices.includes(r)) choices.push(r);
    }

    choices.forEach(opt => {
        const div = document.createElement('div');
        div.className = 'upgrade-card';
        div.innerHTML = `
            <div class="upgrade-icon">${opt.icon}</div>
            <div class="upgrade-title">${opt.title}</div>
            <div class="upgrade-desc">${opt.desc}</div>
        `;
        div.onclick = () => {
            opt.func();
            modal.style.display = 'none';
            GAME.state = 'PLAYING';
            GAME.difficulty++;
            startNewMission();
        };
        container.appendChild(div);
    });
}

function gameLoop(timestamp) {
    if (!lastTime) lastTime = timestamp;
    const dt = (timestamp - lastTime) / 1000;
    lastTime = timestamp;

    ctx.clearRect(0,0,GAME.width, GAME.height);

    if (P1.hp <= 0 || P2.hp <= 0) { // Herhangi biri Ã¶lÃ¼rse oyun biter
        ctx.fillStyle = 'red'; ctx.font = "60px Arial"; ctx.textAlign = "center";
        ctx.fillText("OYUN BÄ°TTÄ°", GAME.width/2, GAME.height/2);
        ctx.font = "30px Arial"; ctx.fillStyle = "white";
        ctx.fillText("Toplam Puan: " + GAME.totalScore, GAME.width/2, GAME.height/2 + 50);
        ctx.font = "20px Arial"; ctx.fillStyle = "#aaa";
        ctx.fillText("Yeniden baÅŸlamak iÃ§in F5'e bas", GAME.width/2, GAME.height/2 + 90);
        return;
    }

    if (GAME.state !== 'MENU') updateGame(dt);

    // Ã‡izim SÄ±rasÄ±
    bgGrid.draw(ctx);

    // Ä°p
    const dist = Math.hypot(P1.x-P2.x, P1.y-P2.y);
    const tension = Math.min(1, dist / GAME.maxTetherDist);
    // Ä°p rengi gerildikÃ§e kÄ±rmÄ±zÄ±ya dÃ¶ner
    ctx.strokeStyle = `rgb(255, ${255 * (1-tension)}, ${255 * (1-tension)})`;
    ctx.lineWidth = 5.1 - (tension * 5); // Gerilince incelmesi yerine kalÄ±nlaÅŸÄ±p titremesi daha iyi efekt verir mi?
    // Basit Ã§izgi:
    ctx.beginPath(); ctx.moveTo(P1.x, P1.y); ctx.lineTo(P2.x, P2.y); ctx.stroke();

    items.forEach(i => i.draw(ctx));
    P1.draw(ctx); P2.draw(ctx);
    bullets.forEach(b => b.draw(ctx));
    particles.forEach(p => p.draw(ctx));

    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
